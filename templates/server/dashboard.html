{% extends "base.html" %}

{% block title %}联邦学习可视化演示 - 服务器控制台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/server.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
{% endblock %}

{% block content %}
<header>
    <button class="help-button" id="help-btn" title="帮助">
        <i class="fas fa-question"></i>
    </button>
</header>

<!-- 介绍按钮 -->
<button class="intro-button" id="intro-btn" title="系统介绍">
    <i class="fas fa-info"></i>
</button>

<div class="container">
    <!-- 左侧控制面板 -->
    <div class="sidebar">        <div class="control-panel">
            <h2>控制面板</h2>            <div class="add-node-section">
                <label for="client-id-input">通过客户端ID添加节点:</label>
                <div class="input-with-button">
                    <input type="text" id="client-id-input" placeholder="例: CLIENT_A1B2C3D4" maxlength="16" pattern="CLIENT_[A-Z0-9]{8}">
                    <button id="add-node-btn" class="btn">添加节点</button>
                </div>
                <div class="param-hint">请输入有效的客户端ID格式</div>
            </div>
            
            <div class="training-params">
                <h3>训练参数</h3>                <div class="param-group">
                    <label for="rounds-value">训练轮数:</label>
                    <div class="input-with-buttons">
                        <button class="btn-small btn-adjust" id="round-minus"><i class="fas fa-minus"></i></button>
                        <span id="rounds-value" class="param-value">3</span>
                        <button class="btn-small btn-adjust" id="round-plus"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                
                <div class="param-group">
                    <label for="clients-value">每轮参与客户端数:</label>
                    <div class="input-with-buttons">
                        <button class="btn-small btn-adjust" id="client-minus"><i class="fas fa-minus"></i></button>
                        <span id="clients-value" class="param-value">1</span>
                        <button class="btn-small btn-adjust" id="client-plus"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="param-hint">最大值由已添加节点数决定</div>
                </div>
            </div>            <div class="training-controls">
                <button id="start-training-btn" class="btn btn-primary"><i class="fas fa-play"></i> 开始训练</button>
                <button id="stop-training-btn" class="btn btn-warning" disabled><i class="fas fa-stop"></i> 停止训练</button>
            </div>
            <button id="reset-btn" class="btn btn-danger"><i class="fas fa-redo"></i> 重置</button>

            <div class="tip-box">
                <p><i class="fas fa-info-circle"></i> 提示：</p>                <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6;">
                    <li>双击网络区域可重置大小，右下角可拖动调整大小</li>
                    <li>可一次性上传多张图片作为训练数据</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- 中间可视化区域 -->
    <div class="main-content">        <div id="network-container">
            <div id="central-node" class="node central-node">
                <div class="node-header">
                    <span class="node-title"><i class="fas fa-server"></i> 中心服务器</span>
                </div>
                <div class="node-content">
                    <div class="node-status">待机中</div>
                </div>
            </div>
            <div id="nodes-container"></div>
        </div>
    </div>
      <!-- 右侧训练状态区域 -->
    <div class="status-sidebar">
        <div class="training-status-panel">
            <h3>训练状态</h3>
            <div id="status-display" class="status-box">
                <p>等待开始训练...</p>
            </div>
        </div>
        
        <!-- 客户端状态监控 -->
        <div class="client-status-panel">
            <h3>客户端状态</h3>
            <div id="client-status-list" class="client-status-list">
                <!-- 动态添加客户端状态 -->
            </div>
        </div>
        
        <!-- 服务器日志 -->
        <div class="server-logs-panel">
            <h3>服务器日志</h3>
            <div class="log-controls">
                <button id="clear-server-logs" class="btn btn-small">
                    <i class="fas fa-trash"></i> 清除
                </button>
            </div>
            <div id="server-logs-content" class="logs-content">
                <!-- 动态添加日志条目 -->
            </div>
        </div>
    </div>
</div>

<!-- 节点模板 (隐藏) -->
<template id="node-template">
    <div class="node client-node">
        <div class="node-header">
            <span class="node-title"><i class="fas fa-laptop"></i> 节点</span>
            <button class="node-remove-btn">×</button>
        </div>
        <div class="node-content">
            <div class="node-status">待机中</div>
            <div class="image-upload">                <label for="image-input">
                    <div class="upload-placeholder">
                        <span>点击上传图片数据</span>
                    </div>
                </label>
                <input type="file" accept="image/*" multiple class="image-input" />
            </div>            <div class="uploaded-info">
                <span class="uploaded-count">0</span> 张图片
            </div>
        </div>
    </div>
</template>

<div id="message-log" class="message-log">        
    <div class="message-log-header">
        <h3>训练日志</h3>
        <div class="log-buttons">
            <button id="magnify-log-btn" class="btn btn-small" title="放大显示"><i class="fas fa-expand"></i></button>
            <button id="clear-log-btn" class="btn btn-small"><i class="fas fa-trash-alt"></i> 清除</button>
        </div>
    </div>
    <div id="log-content"></div>
</div>

<!-- 帮助弹窗 -->
<div id="help-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-question-circle"></i> 使用帮助</h2>
            <button class="modal-close" id="help-close-btn">&times;</button>
        </div>
        <div class="modal-content">
            <h3>🎯 系统概述</h3>
            <p>联邦学习可视化演示系统帮助您直观理解联邦学习的训练过程，通过可视化界面展示多个节点协同训练全局模型的完整流程。</p>                <h3>🖱️ 界面操作</h3>
                <div class="feature-list">
                    <ul>
                        <li><strong>节点拖拽：</strong>点击并拖动节点标题栏可以重新排列节点位置，让您自定义网络拓扑布局</li>
                        <li><strong>容器调整：</strong>网络显示区域右下角可拖拽调整大小，双击网络区域可重置为默认大小</li>
                        <li><strong>数据上传：</strong>点击节点中的上传区域可选择多张图片作为该节点的训练数据</li>
                        <li><strong>参数调整：</strong>使用左侧控制面板的 + / - 按钮调整训练轮数和参与客户端数量</li>
                    </ul>
                </div>

                <h3>⚙️ 训练参数</h3>
                <ul>
                    <li><span class="highlight">训练轮数</span>：设置联邦学习的总轮数（1-10轮）</li>
                    <li><span class="highlight">每轮参与客户端数</span>：设置每轮参与训练的节点数量，0表示全部节点参与</li>
                </ul>

                <h3>🔄 训练流程</h3>
                <ol>
                    <li><strong>添加节点：</strong>使用"添加节点"按钮创建客户端节点（最多8个）</li>
                    <li><strong>上传数据：</strong>为每个节点上传训练图片数据</li>
                    <li><strong>设置参数：</strong>配置训练轮数和参与客户端数量</li>
                    <li><strong>开始训练：</strong>点击"开始训练"观察联邦学习过程</li>
                    <li><strong>观察过程：</strong>通过节点颜色变化和日志信息了解训练进展</li>
                </ol>

                <h3>🎨 状态指示</h3>
                <ul>
                    <li><strong>蓝色脉冲：</strong>节点正在进行本地训练</li>
                    <li><strong>淡蓝色：</strong>节点正在上传模型参数</li>
                    <li><strong>绿色：</strong>节点训练完成</li>
                    <li><strong>中心节点颜色变化：</strong>表示全局模型聚合状态</li>
                </ul>

                <h3>💡 使用技巧</h3>
                <div class="feature-list">
                    <ul>
                        <li>训练过程中可以随时点击"停止训练"终止当前轮次</li>
                        <li>使用"重置"按钮可清空所有节点和设置，重新开始</li>
                        <li>右侧训练状态面板实时显示当前训练进度</li>
                        <li>训练日志记录了详细的操作和状态信息</li>
                    </ul>
                </div>
            
            <h3>📊 训练流程</h3>
            <ol>
                <li>中心服务器向各客户端分发全局模型</li>
                <li>客户端使用本地数据进行模型训练</li>
                <li>客户端将训练后的模型参数上传到中心服务器</li>
                <li>中心服务器聚合所有客户端的参数更新全局模型</li>
                <li>重复以上步骤直到达到指定训练轮数</li>
            </ol>
        </div>
    </div>
</div>

<!-- 错误提示弹窗 -->
<div id="error-modal" class="modal-overlay error-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> 错误提示</h2>
            <button class="modal-close" id="error-close-btn">&times;</button>
        </div>
        <div class="modal-content">
            <p id="error-message">出现了一个错误</p>
        </div>
    </div>
</div>

<!-- 系统介绍弹窗 -->
<div id="intro-modal" class="modal-overlay">
    <div class="modal">        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-info-circle"></i> 系统介绍</h2>
            <button class="modal-close" id="intro-close-btn">&times;</button>
        </div>            
        <div class="modal-content">
            <h3>🏥 医联济邦：区块链赋能下的联邦医学影像协同诊断系统</h3>
            <p>本系统是一种结合联邦学习与区块链技术的分布式医学影像诊断系统，旨在在保护患者隐私的前提下，提升医疗影像诊断的准确性与协同效率，解决传统医疗系统中的数据孤岛、隐私保护与资源不均等问题。</p>
            
            <h3>🎯 系统目标</h3>
            <ul>
                <li><strong>提升诊断智能化水平：</strong>克服人工判断主导的低效模式，减少因医生疲劳导致的漏诊问题，利用AI技术提升对复杂病灶（如早期肿瘤、微小钙化灶等）的识别率与诊断准确性</li>
                <li><strong>打破数据孤岛，实现跨机构协作：</strong>融合多家医院的异构影像数据资源，通过联邦学习实现模型协同训练而不交换原始数据</li>
                <li><strong>加强数据隐私与安全保护：</strong>采用联邦学习、差分隐私、同态加密和区块链技术，保障患者数据在使用过程中的私密性与可追溯性</li>
                <li><strong>推动医疗资源均衡化：</strong>支持边远或资源有限地区接入先进AI诊断模型，降低高质量医疗资源的不均衡带来的服务落差</li>
            </ul>
            
            <h3>🚀 核心功能</h3>
            <div class="feature-list">
                <ul>
                    <li><strong>分布式协同训练：</strong>医院本地训练模型，仅上传模型参数，不传输原始数据，支持异步更新与周期性同步机制</li>
                    <li><strong>多重隐私保护机制：</strong>差分隐私、同态加密、区块链溯源，全方位保障数据安全</li>
                    <li><strong>智能合约自动管理：</strong>注册客户端、验证身份、任务分配与激励发放全流程自动执行</li>
                </ul>
            </div>
            
            <h3>💡 技术创新点</h3>
            <ul>
                <li><strong>联邦学习与区块链深度融合：</strong>将模型更新与参数同步过程上链，利用智能合约记录操作、参与机构与更新内容</li>
                <li><strong>面向多机构的数据协同：</strong>在不泄露原始数据的前提下实现跨医院协同建模，保证隐私合规的同时提升模型泛化能力</li>
                <li><strong>高适应性的加密体系：</strong>差分隐私 + 同态加密 + 区块链的组合设计，防止数据泄露、模型推断与操作审计等潜在攻击路径</li>
                <li><strong>支持异构数据与多病种识别：</strong>支持X光、CT、MRI等不同影像类型，具备模型自适应机制</li>
            </ul>
            
            <h3>🎨 适用范围与推广前景</h3>
            <ul>
                <li><strong>目标用户：</strong>各级医疗机构、远程诊断平台、影像中心</li>
                <li><strong>适配场景：</strong>肺结节筛查、乳腺癌识别、阿尔茨海默病早筛等</li>
                <li><strong>市场潜力：</strong>面向全球医疗AI和分布式协作市场，具有广阔商业化应用前景</li>
            </ul>
            
            <h3>✨ 预期成果与影响</h3>
            <div class="feature-list">
                <ul>
                    <li><strong>准确性提升：</strong>模型敏感度优于传统人工诊断</li>
                    <li><strong>隐私安全保障：</strong>满足GDPR、HIPAA等国际法规</li>
                    <li><strong>协作网络构建：</strong>构建医院联盟，打破信息孤岛</li>
                    <li><strong>经济社会效益：</strong>推动智能医疗落地，促进医疗公平化发展</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 日志放大弹窗 -->
<div id="log-modal" class="modal-overlay log-modal">    <div class="modal log-modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-list-alt"></i> 训练日志详情</h2>
            <button class="modal-close" id="log-close-btn">&times;</button>
        </div>
        <div class="modal-content log-modal-body">
            <div id="log-modal-content"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SocketIO CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/server.js') }}"></script>
<!-- 初始化SocketIO连接 -->
<script>
// 初始化SocketIO连接
const socket = io();
const userType = 'server'; // 服务器端
const userName = '{{ current_user.username }}';

// 注册为服务器端客户端
socket.emit('register_client', {
    type: userType,
    name: userName
});

// 监听注册确认
socket.on('registration_confirmed', (data) => {
    console.log('服务器端注册成功:', data);
    addLogEntry('系统', '服务器端连接成功');
});

// 监听客户端连接
socket.on('client_connected', (data) => {
    console.log('新客户端连接:', data);
    addLogEntry('系统', `客户端 ${data.client_name} 已连接`);
    updateConnectedClientsDisplay();
});

// 监听客户端断开连接
socket.on('client_disconnected', (data) => {
    console.log('客户端断开连接:', data);
    addLogEntry('系统', `客户端 ${data.client_name} 已断开连接`);
    updateConnectedClientsDisplay();
});

// 监听训练开始确认
socket.on('training_started', (data) => {
    console.log('训练已开始:', data);
    addLogEntry('系统', `联邦学习训练已开始，${data.participating_clients} 个客户端参与，总轮数: ${data.rounds}`);
    addLogEntry('系统', `参与的客户端: ${data.client_list.join(', ')}`);
});

// 监听客户端完成训练轮次
socket.on('client_round_complete', (data) => {
    console.log('客户端完成训练轮次:', data);
    addLogEntry('训练', `客户端 ${data.client_name} 完成第 ${data.round} 轮训练 - Loss: ${data.loss.toFixed(4)}, Accuracy: ${(data.accuracy * 100).toFixed(2)}%`);
});

// 监听节点状态更新
socket.on('node_status_updated', (data) => {
    console.log('节点状态更新:', data);
    addLogEntry('状态', `节点 ${data.node_id}: ${data.status} - ${data.message}`);
});

// 更新已连接客户端显示
function updateConnectedClientsDisplay() {
    socket.emit('get_connected_clients');
}

socket.on('connected_clients_list', (data) => {
    const statusDisplay = document.getElementById('status-display');
    if (statusDisplay) {
        statusDisplay.innerHTML = `
            <div class="status-item">
                <span class="status-label">已连接客户端:</span>
                <span class="status-value">${data.total}</span>
            </div>
            <div class="clients-list">
                ${data.clients.map(client => 
                    `<div class="client-item">
                        <i class="fas fa-circle text-success"></i>
                        ${client.name}
                        <small>(${new Date(client.connected_at).toLocaleTimeString()})</small>
                    </div>`
                ).join('')}
            </div>
        `;
    }
});

// 将socket对象暴露给其他脚本使用
window.flSocket = socket;
</script>
{% endblock %}